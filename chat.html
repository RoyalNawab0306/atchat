<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chats</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
:root { --primary: #6366f1; --bg: #f8faff; }
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.header {
    padding: 30px 20px 20px;
    background: white;
    border-radius: 0 0 35px 35px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.02);
}

.top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.search-row {
    background: #f1f5f9;
    border-radius: 18px;
    padding: 12px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-row input {
    border: none;
    background: none;
    outline: none;
    width: 100%;
    font-size: 15px;
}

.content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 22px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: 0.2s;
}

.chat-item:active {
    transform: scale(0.97);
}

.avatar {
    width: 55px;
    height: 55px;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 20px;
    margin-right: 15px;
}

.info { flex: 1; }

.info b {
    display: block;
    font-size: 16px;
    color: #1e293b;
    margin-bottom: 4px;
}

.info span {
    font-size: 13px;
    color: #94a3b8;
}

.nav-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    background: #1e293b;
    border-radius: 25px;
    display: flex;
    justify-content: space-around;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.nav-btn {
    color: #64748b;
    font-size: 20px;
    border: none;
    background: none;
    cursor: pointer;
}

.nav-btn.active {
    color: white;
}

@media(min-width: 768px) {
    body { max-width: 450px; margin: auto; }
}
</style>
</head>
<body>

<div class="header">
    <div class="top-row">
        <div>
            <span style="color:#94a3b8; font-size: 14px;">Hello,</span>
            <h2 id="username" style="margin:0; font-size: 24px;">User</h2>
        </div>
        <div class="search-row" style="width: 50px; padding: 12px; border-radius: 15px;">
            <i class="fa fa-search"></i>
        </div>
    </div>

    <div class="search-row">
        <input type="text" id="searchInput" placeholder="Search contacts..." onkeyup="filterUsers()">
    </div>
</div>

<div class="content" id="chat-list">
    <p style="text-align:center;color:#94a3b8;">Loading users...</p>
</div>

<div class="nav-bar">
    <button class="nav-btn active"><i class="fa-solid fa-comment-dots"></i></button>
    <button class="nav-btn" onclick="location.href='calling.html'"><i class="fa-solid fa-phone"></i></button>
    <button class="nav-btn" onclick="location.href='profile.html'"><i class="fa-solid fa-user"></i></button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzPyWTkn5L94I9PJ5KM_JNonvb8dOTpEA4tbqKC7d2j8I10W7xMsHHeOCroXcimWsy6jQ/exec";
const currentUser = JSON.parse(localStorage.getItem("user"));

if (!currentUser) {
    location.href = "login.html";
}

// Show logged-in user name
document.getElementById("username").innerText = currentUser.name;

// Fetch Users
async function fetchUsers() {
    try {
        const res = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                action: "getUsers",
                user_id: currentUser.user_id
            })
        });

        const data = await res.json();

        if (data.status === "success") {
            renderUsers(data.users.filter(u => u.user_id != currentUser.user_id));
        } else {
            document.getElementById("chat-list").innerHTML =
                "<p style='text-align:center;color:#94a3b8;'>No users found</p>";
        }

    } catch (err) {
        document.getElementById("chat-list").innerHTML =
            "<p style='text-align:center;color:red;'>Server error</p>";
    }
}

function renderUsers(users) {
    const container = document.getElementById("chat-list");

    if (users.length === 0) {
        container.innerHTML =
            "<p style='text-align:center;color:#94a3b8;'>No users available</p>";
        return;
    }

    container.innerHTML = users.map(u => `
        <div class="chat-item" onclick='openChat(${JSON.stringify(u)})'>
            <div class="avatar" style="background:${randomColor()}">
                ${u.name.charAt(0).toUpperCase()}
            </div>
            <div class="info">
                <b>${u.name}</b>
                <span>Tap to chat</span>
            </div>
        </div>
    `).join("");
}

function openChat(user) {
    localStorage.setItem("selectedUser", JSON.stringify(user));
    location.href = "messaging.html";
}

function filterUsers() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll(".chat-item").forEach(item => {
        const name = item.querySelector("b").innerText.toLowerCase();
        item.style.display = name.includes(search) ? "flex" : "none";
    });
}

function randomColor() {
    const colors = ["#6366f1","#ec4899","#10b981","#f59e0b","#8b5cf6"];
    return colors[Math.floor(Math.random() * colors.length)];
}

fetchUsers();
</script>

</body>
</html>
